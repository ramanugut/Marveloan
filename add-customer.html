<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Marveloan - Add Customer</title>
    <style>
        * { margin:0; padding:0; box-sizing:border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            min-height: 100vh;
            color: #1a202c;
        }
        .header {
            background: rgba(255,255,255,0.15);
            backdrop-filter: blur(25px);
            border-bottom: 1px solid rgba(255,255,255,0.18);
            padding: 0.75rem 1.5rem;
            display:flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 24px rgba(0,0,0,0.08);
            position: sticky;
            top:0;
            z-index:100;
        }
        .logo{display:flex;align-items:center;gap:0.75rem;}
        .logo-icon{width:32px;height:32px;background:linear-gradient(135deg,#667eea,#764ba2);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:1.2rem;color:#fff;font-weight:bold;}
        .logo h1{
            color:white;
            font-size:1.5rem;
            font-weight:700;
        }
        .user-info{display:flex;align-items:center;gap:0.75rem;}
        .user-avatar{width:36px;height:36px;border-radius:50%;background:linear-gradient(135deg,#667eea,#764ba2);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:600;cursor:pointer;transition:all 0.3s ease;font-size:0.85rem;border:2px solid rgba(255,255,255,0.2);}
        .back-button{background:rgba(255,255,255,0.15);backdrop-filter:blur(10px);color:white;border:1px solid rgba(255,255,255,0.2);border-radius:8px;padding:0.5rem 1rem;cursor:pointer;display:flex;align-items:center;gap:0.5rem;transition:all 0.3s ease;text-decoration:none;font-size:0.9rem;}
        .back-button:hover{background:rgba(255,255,255,0.2);transform:translateX(-2px);}
        .main-container{max-width:1200px;margin:0 auto;padding:2rem;}
        .page-header{background:rgba(255,255,255,0.12);backdrop-filter:blur(20px);border-radius:16px;padding:1.5rem;margin-bottom:2rem;box-shadow:0 8px 32px rgba(0,0,0,0.1);border:1px solid rgba(255,255,255,0.2);}
        .page-title{font-size:1.8rem;font-weight:700;color:white;margin-bottom:0.5rem;display:flex;align-items:center;gap:0.5rem;}
        .page-subtitle{color:rgba(255,255,255,0.8);font-size:1rem;}
        .form-container{background:rgba(255,255,255,0.12);backdrop-filter:blur(20px);border-radius:16px;padding:2rem;box-shadow:0 8px 32px rgba(0,0,0,0.1);border:1px solid rgba(255,255,255,0.2);}
        .progress-steps{display:flex;justify-content:space-between;margin-bottom:2rem;position:relative;}
        .progress-steps::before{content:'';position:absolute;top:20px;left:0;right:0;height:2px;background:rgba(255,255,255,0.2);z-index:1;}
        .progress-line{position:absolute;top:20px;left:0;height:2px;background:linear-gradient(90deg,#4299e1,#63b3ed);transition:width 0.5s ease;z-index:2;width:33.33%;}
        .step{display:flex;flex-direction:column;align-items:center;position:relative;z-index:3;}
        .step-circle{width:40px;height:40px;border-radius:50%;background:rgba(255,255,255,0.2);display:flex;align-items:center;justify-content:center;color:rgba(255,255,255,0.6);font-weight:600;margin-bottom:0.5rem;transition:all 0.3s ease;}
        .step.active .step-circle{background:linear-gradient(135deg,#4299e1,#63b3ed);color:white;}
        .step.completed .step-circle{background:linear-gradient(135deg,#48bb78,#68d391);color:white;}
        .step-label{font-size:0.8rem;color:rgba(255,255,255,0.7);text-align:center;}
        .step.active .step-label{color:white;font-weight:600;}
        .form-section{display:none;animation:fadeInUp 0.5s ease-out;}
        .form-section.active{display:block;}
        .section-title{font-size:1.3rem;font-weight:600;color:white;margin-bottom:1.5rem;display:flex;align-items:center;gap:0.5rem;}
        .form-group{margin-bottom:1.5rem;}
        .form-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:1rem;}
        .form-label{display:block;color:white;font-weight:500;margin-bottom:0.5rem;font-size:0.9rem;}
        .required{color:#ff6b6b;}
        .form-input{width:100%;padding:0.75rem 1rem;background:rgba(255,255,255,0.1);backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,0.2);border-radius:8px;color:white;font-size:0.9rem;transition:all 0.3s ease;outline:none;}
        .form-input::placeholder{color:rgba(255,255,255,0.5);}
        .form-input:focus{border-color:#4299e1;background:rgba(255,255,255,0.15);box-shadow:0 0 0 3px rgba(66,153,225,0.1);}
        .form-select{width:100%;padding:0.75rem 1rem;background:rgba(255,255,255,0.1);backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,0.2);border-radius:8px;color:white;font-size:0.9rem;transition:all 0.3s ease;outline:none;cursor:pointer;}
        .form-select option{background:#2d3748;color:white;}
        .form-textarea{width:100%;padding:0.75rem 1rem;background:rgba(255,255,255,0.1);backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,0.2);border-radius:8px;color:white;font-size:0.9rem;transition:all 0.3s ease;outline:none;resize:vertical;min-height:100px;font-family:inherit;}
        .file-upload{position:relative;display:inline-block;width:100%;}
        .file-input{display:none;}
        .file-label{display:flex;align-items:center;justify-content:center;gap:0.5rem;padding:2rem 1rem;border:2px dashed rgba(255,255,255,0.3);border-radius:8px;cursor:pointer;transition:all 0.3s ease;color:rgba(255,255,255,0.7);background:rgba(255,255,255,0.05);}
        .file-label:hover{border-color:#4299e1;background:rgba(66,153,225,0.1);color:white;}
        .form-actions{display:flex;justify-content:space-between;gap:1rem;margin-top:2rem;padding-top:1.5rem;border-top:1px solid rgba(255,255,255,0.1);}
        .btn{padding:0.75rem 1.5rem;border-radius:8px;font-weight:600;font-size:0.9rem;cursor:pointer;transition:all 0.3s ease;border:none;outline:none;text-decoration:none;display:inline-flex;align-items:center;gap:0.5rem;}
        .btn-secondary{background:rgba(255,255,255,0.1);color:white;border:1px solid rgba(255,255,255,0.2);}
        .btn-secondary:hover{background:rgba(255,255,255,0.15);transform:translateY(-1px);}
        .btn-primary{background:linear-gradient(135deg,#4299e1,#63b3ed);color:white;box-shadow:0 4px 15px rgba(66,153,225,0.3);}
        .btn-primary:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(66,153,225,0.4);}
        .btn-success{background:linear-gradient(135deg,#48bb78,#68d391);color:white;box-shadow:0 4px 15px rgba(72,187,120,0.3);}
        .btn-success:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(72,187,120,0.4);}
        .success-message{text-align:center;padding:3rem 2rem;}
        .success-icon{width:80px;height:80px;background:linear-gradient(135deg,#48bb78,#68d391);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:2rem;color:white;margin:0 auto 1.5rem;}
        .success-title{font-size:1.5rem;font-weight:700;color:white;margin-bottom:0.5rem;}
        .success-subtitle{color:rgba(255,255,255,0.8);margin-bottom:2rem;}
        @media (max-width:768px){.main-container{padding:1rem;} .header{padding:0.75rem 1rem;} .form-container{padding:1.5rem;} .progress-steps{flex-direction:column;gap:1rem;align-items:center;} .progress-steps::before{display:none;} .progress-line{display:none;} .step{flex-direction:row;gap:1rem;width:100%;justify-content:flex-start;} .step-circle{margin-bottom:0;} .form-row{grid-template-columns:1fr;} .form-actions{flex-direction:column;} .page-title{font-size:1.4rem;}}
        @keyframes fadeInUp{from{opacity:0;transform:translateY(30px);}to{opacity:1;transform:translateY(0);}}
        .form-section{animation:fadeInUp 0.5s ease-out;}
    </style>
</head>
<body>
    <header class="header">
        <div class="logo">
            <div class="logo-icon">L</div>
            <h1>Marveloan</h1>
        </div>
        <a href="dashboard.html" class="back-button">‚Üê Back to Dashboard</a>
        <div class="user-info">
            <div class="user-avatar">MR</div>
        </div>
    </header>

    <div class="main-container">
        <div class="page-header">
            <h1 class="page-title">üë§ Add New Customer</h1>
            <p class="page-subtitle">Create a comprehensive customer profile to get started with loan services</p>
        </div>

        <div class="form-container">
            <div class="progress-steps">
                <div class="progress-line" id="progressLine"></div>
                <div class="step active" id="step1">
                    <div class="step-circle">1</div>
                    <div class="step-label">Personal Info</div>
                </div>
                <div class="step" id="step2">
                    <div class="step-circle">2</div>
                    <div class="step-label">Contact & Address</div>
                </div>
                <div class="step" id="step3">
                    <div class="step-circle">3</div>
                    <div class="step-label">Financial Info</div>
                </div>
                <div class="step" id="step4">
                    <div class="step-circle">‚úì</div>
                    <div class="step-label">Complete</div>
                </div>
            </div>

            <form id="customerForm">
                <div class="form-section active" id="section1">
                    <h2 class="section-title">üìã Personal Information</h2>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">First Name <span class="required">*</span></label>
                            <input type="text" class="form-input" name="firstName" placeholder="Enter first name" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Last Name <span class="required">*</span></label>
                            <input type="text" class="form-input" name="lastName" placeholder="Enter last name" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Middle Name</label>
                            <input type="text" class="form-input" name="middleName" placeholder="Enter middle name">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Date of Birth <span class="required">*</span></label>
                            <input type="date" class="form-input" name="dateOfBirth" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Gender <span class="required">*</span></label>
                            <select class="form-select" name="gender" required>
                                <option value="">Select gender</option>
                                <option value="male">Male</option>
                                <option value="female">Female</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Marital Status</label>
                            <select class="form-select" name="maritalStatus">
                                <option value="">Select status</option>
                                <option value="single">Single</option>
                                <option value="married">Married</option>
                                <option value="divorced">Divorced</option>
                                <option value="widowed">Widowed</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">National ID Number <span class="required">*</span></label>
                        <input type="text" class="form-input" name="nationalId" placeholder="Enter national ID number" required>
                    </div>
                </div>

                <div class="form-section" id="section2">
                    <h2 class="section-title">üìû Contact & Address Information</h2>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Phone Number <span class="required">*</span></label>
                            <input type="tel" class="form-input" name="phoneNumber" placeholder="+27 60 000 0000" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Alternative Phone</label>
                            <input type="tel" class="form-input" name="altPhoneNumber" placeholder="+27 60 000 0000">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Email Address <span class="required">*</span></label>
                        <input type="email" class="form-input" name="email" placeholder="customer@example.com" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Home Address <span class="required">*</span></label>
                        <textarea class="form-textarea" name="homeAddress" placeholder="Enter complete home address" required></textarea>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">City <span class="required">*</span></label>
                            <input type="text" class="form-input" name="city" placeholder="Enter city" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">State <span class="required">*</span></label>
                            <select class="form-select" name="state" required>
                                <option value="">Select state</option>
                                <option value="gauteng">Gauteng</option>
                                <option value="western-cape">Western Cape</option>
                                <option value="kwazulu-natal">KwaZulu-Natal</option>
                                <option value="eastern-cape">Eastern Cape</option>
                                <option value="free-state">Free State</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Postal Code</label>
                        <input type="text" class="form-input" name="postalCode" placeholder="Enter postal code">
                    </div>
                </div>

                <div class="form-section" id="section3">
                    <h2 class="section-title">üíº Financial Information</h2>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Employment Status <span class="required">*</span></label>
                            <select class="form-select" name="employmentStatus" required>
                                <option value="">Select employment status</option>
                                <option value="employed">Employed</option>
                                <option value="self-employed">Self Employed</option>
                                <option value="unemployed">Unemployed</option>
                                <option value="retired">Retired</option>
                                <option value="student">Student</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Monthly Income <span class="required">*</span></label>
                            <input type="number" class="form-input" name="monthlyIncome" placeholder="R 0.00" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Employer <span class="required">*</span></label>
                            <input type="text" class="form-input" id="employerName" name="employerName" placeholder="Enter employer name" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Employer Code</label>
                            <input type="text" class="form-input" id="employerCode" name="employerCode" readonly>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Job Title</label>
                            <input type="text" class="form-input" name="jobTitle" placeholder="Enter job title">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Work Address</label>
                        <textarea class="form-textarea" name="workAddress" placeholder="Enter complete work address"></textarea>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Bank Name <span class="required">*</span></label>
                            <select class="form-select" name="bankName" required>
                                <option value="">Select bank</option>
                                <option value="absa">ABSA</option>
                                <option value="standard-bank">Standard Bank</option>
                                <option value="fnb">FNB</option>
                                <option value="nedbank">Nedbank</option>
                                <option value="capitec">Capitec</option>
                                <option value="investec">Investec</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Account Number <span class="required">*</span></label>
                            <input type="text" class="form-input" name="accountNumber" placeholder="0000000000" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Account Name</label>
                        <input type="text" class="form-input" name="accountName" placeholder="Account holder name">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Upload ID Document <span class="required">*</span></label>
                        <div class="file-upload">
                            <input type="file" class="file-input" id="idDocument" name="idDocument" accept=".jpg,.jpeg,.png,.pdf" required>
                            <label for="idDocument" class="file-label">üìé Click to upload ID document (PDF, JPG, PNG)</label>
                        </div>
                    </div>
                </div>

                <div class="form-section" id="section4">
                    <div class="success-message">
                        <div class="success-icon">‚úÖ</div>
                        <h2 class="success-title">Customer Added Successfully!</h2>
                        <p class="success-subtitle">The new customer profile has been created and is ready for loan applications.</p>
                        <div class="form-actions">
                            <button type="button" class="btn btn-secondary" onclick="addAnother()">‚ûï Add Another Customer</button>
                            <button type="button" class="btn btn-primary" onclick="viewCustomer()">üëÅÔ∏è View Customer Profile</button>
                        </div>
                    </div>
                </div>

                <div class="form-actions" id="formActions">
                    <button type="button" class="btn btn-secondary" id="prevBtn" onclick="previousStep()">‚Üê Previous</button>
                    <button type="button" class="btn btn-primary" id="nextBtn" onclick="nextStep()">Next ‚Üí</button>
                    <button type="submit" class="btn btn-success" id="submitBtn" style="display:none;">‚úÖ Create Customer</button>
                </div>
            </form>
        </div>
    </div>

    <script type="module">
        import { db } from './firebase-config.js';
        import { collection, doc, setDoc } from 'https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js';
        let currentStep = 1;
        const totalSteps = 3;

        function nextStep(){
            if(validateCurrentStep()){
                if(currentStep < totalSteps){
                    currentStep++;
                    updateSteps();
                }
            }
        }
        function previousStep(){
            if(currentStep>1){
                currentStep--;
                updateSteps();
            }
        }
        function validateCurrentStep(){
            const currentSection=document.getElementById(`section${currentStep}`);
            const requiredFields=currentSection.querySelectorAll('[required]');
            let valid=true;
            requiredFields.forEach(f=>{
                if(!f.value.trim()){
                    f.style.borderColor='#ff6b6b';
                    valid=false;
                }else{
                    f.style.borderColor='rgba(255,255,255,0.2)';
                }
            });
            if(!valid) alert('Please fill in all required fields before proceeding.');
            return valid;
        }
        function updateSteps(){
            document.querySelectorAll('.form-section').forEach(s=>s.classList.remove('active'));
            document.getElementById(`section${currentStep}`).classList.add('active');
            for(let i=1;i<=4;i++){
                const step=document.getElementById(`step${i}`);
                step.classList.remove('active','completed');
                if(i<currentStep) step.classList.add('completed');
                else if(i===currentStep) step.classList.add('active');
            }
            const progressWidth=((currentStep-1)/(totalSteps-1))*100;
            document.getElementById('progressLine').style.width=`${progressWidth}%`;
            document.getElementById('prevBtn').style.display=currentStep===1?'none':'inline-flex';
            document.getElementById('nextBtn').style.display=currentStep===totalSteps?'none':'inline-flex';
            document.getElementById('submitBtn').style.display=currentStep===totalSteps?'inline-flex':'none';
            document.getElementById('formActions').style.display=currentStep===4?'none':'flex';
        }
        const form=document.getElementById('customerForm');
        const employerNameInput=document.getElementById('employerName');
        const employerCodeInput=document.getElementById('employerCode');

        function generateCode(name){
            const prefix=name.trim().slice(0,3).toUpperCase();
            return prefix+Date.now().toString().slice(-4);
        }

        employerNameInput.addEventListener('input',()=>{
            employerCodeInput.value = employerNameInput.value ? generateCode(employerNameInput.value) : '';
        });

        const urlParams=new URLSearchParams(window.location.search);
        const editId=urlParams.get('id');
        if(editId){
            const customers=JSON.parse(localStorage.getItem('customers'))||[];
            const customer=customers.find(c=>c.id==editId);
            if(customer){
                Object.keys(customer).forEach(k=>{if(form.elements[k]) form.elements[k].value=customer[k];});
            }
        }

        form.addEventListener('submit',async function(e){
            e.preventDefault();
            if(validateCurrentStep()){
                const data={};
                new FormData(form).forEach((v,k)=>data[k]=v);
                const customers = JSON.parse(localStorage.getItem('customers')) || [];
                if(editId){
                    const idx=customers.findIndex(c=>c.id==editId);
                    if(idx>-1){data.id=customers[idx].id;customers[idx]=data;}
                }else{
                    data.id=Date.now();
                    customers.push(data);
                }
                localStorage.setItem('recentCustomer', JSON.stringify(data));
                localStorage.setItem('customers', JSON.stringify(customers));

                let employers=JSON.parse(localStorage.getItem('employers'))||[];
                let employerDoc=null;
                if(data.employerName){
                    let emp=employers.find(e=>e.name.toLowerCase()==data.employerName.toLowerCase());
                    if(!emp){
                        emp={name:data.employerName,code:data.employerCode||generateCode(data.employerName)};
                        employers.push(emp);
                    }
                    employerDoc=emp;
                    localStorage.setItem('employers',JSON.stringify(employers));
                }

                try{
                    await setDoc(doc(collection(db,'customers'), data.id.toString()), data);
                    if(employerDoc){
                        await setDoc(doc(collection(db,'employers'), employerDoc.code), employerDoc);
                    }
                }catch(err){
                    console.error('Firebase save failed', err);
                }

                setTimeout(()=>{currentStep=4;updateSteps();},500);
            }
        });
        function addAnother(){
            document.getElementById('customerForm').reset();
            currentStep=1;
            updateSteps();
        }
        function viewCustomer(){
            window.location.href='customer-profile.html';
        }
        updateSteps();
        window.nextStep = nextStep;
        window.previousStep = previousStep;
        window.addAnother = addAnother;
        window.viewCustomer = viewCustomer;
    </script>
</body>
</html>
